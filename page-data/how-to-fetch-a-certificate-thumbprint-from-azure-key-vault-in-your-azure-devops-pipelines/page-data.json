{"componentChunkName":"component---src-templates-blog-post-js","path":"/how-to-fetch-a-certificate-thumbprint-from-azure-key-vault-in-your-azure-devops-pipelines/","result":{"data":{"site":{"siteMetadata":{"title":"Rasmus Valbro Højte"}},"markdownRemark":{"id":"46eedf13-191a-5a09-87a2-7f4648f58402","excerpt":"If you for whatever reason need to read your certificates thumbprint(or other public certificate information), such as when deploying to an on-premise…","html":"<p>If you for whatever reason need to read your certificates thumbprint(or other public certificate information), such as when deploying to an on-premise environment, then this post can help you.</p>\n<p>I needed to do this because we have to feed the IIS Management task the thumbprint for the certificate installed on the server to run HTTPS.</p>\n<h2>First method: Using the Azure PowerShell Task</h2>\n<p>This method is definitely a little more cumbersome than the second method, but will be safer, if you don’t want to expose your entire PFX, including secrets. This method instead basis itself on creating a service principal with only rights to read public information about your certificate. On the other hand, linking an Azure DevOps library to a Key Vault requires permission to read secrets as well.</p>\n<h3>Prerequisites</h3>\n<ul>\n<li>This method uses the <a href=\"https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/deploy/azure-powershell?view=azure-devops\">Azure PowerShell task</a></li>\n<li>Key Vault set up with certificate already set up</li>\n<li>If you run on Azure’s deployment agents, you can ignore this bullet, but if you run your own agents, you need to install the <a href=\"https://docs.microsoft.com/en-us/powershell/azure/install-az-ps?view=azps-7.1.0\">Azure PowerShell Module</a>, and ensure you run a sufficient version of PowerShell(7.1.0~ at the time of writing)</li>\n</ul>\n<h3>Pipeline setup</h3>\n<p>Add an Azure PowerShell task to your pipeline. Configure it as an inline script.</p>\n<p>Give the task a service connection with a certificate read access principal. See more on this in the next section. Choose to use the latest version of PowerShell.</p>\n<p>Add the following script, but replace the variable with your own key vault name and certificate name:</p>\n<p>$Thumbprint = (Get-AzKeyVaultCertificate -VaultName “ReplaceWithKeyVaultName” -Name “ReplaceWithCertificateName”).Thumbprint</p>\n<p>Write-Host “The thumbprint is $Thumbprint”</p>\n<p>Write-Host “##vso[task.setvariable variable=Tp]$Thumbprint”</p>\n<p>This script will grab the certificate’s public info, and set the Thumbprint variable with the certificate’s thumbprint value.</p>\n<p>The task.setvariable function is a logging command that allows you to assign a pipeline variable at runtime. In this case we pipe it into a variable that’ll be accessible as $(Tp), which can be used like any other pipeline variable wherever you need it.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8b594a37b5c210c8015c500e45325f29/2bef9/logged_output-1024x339.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 32.911392405063296%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABP0lEQVQoz4WQy26cQBBFm+4GBmiezYBnTPMSITOxFTlW/v/Xjg2MpSwSZXFUtblXp0rY2rJRVCVKK6SS+9S+3lFKobX+J77vY60lSQxVZRHd5LgOHZf+SmZznroLVWNJCkOSG4wxnE6nPbyV/w3P8xBCUNQN4vf7L97f3vj5+kJdlazLwjwOXNqWp7Yhz1N8X+2B/7IVN/1K4xZq942iGYjLC2ndUbQ9qb0SFy1RVqPjEhmmqCBCBjFChQfSR6gAoSOEkIjl+51lvbHeXnDDzDAtzMtK50Y6N9CPM+O80I8TwzAxjdP+s8PK+8PwsefuB3l3I3OvZM93KnfD9ndMMxJkZ5Q5I5MzXlQgQ7NbiiBF6Pgwk8ExNzyJCIucMM84lQVBduxxWRJVJXFZ4ekQ4enjNPlV8Dh1t3qwlX0afgAPLKDK4+EHUwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"logged output 1024x339\"\n        title=\"logged output 1024x339\"\n        src=\"/static/8b594a37b5c210c8015c500e45325f29/f058b/logged_output-1024x339.png\"\n        srcset=\"/static/8b594a37b5c210c8015c500e45325f29/c26ae/logged_output-1024x339.png 158w,\n/static/8b594a37b5c210c8015c500e45325f29/6bdcf/logged_output-1024x339.png 315w,\n/static/8b594a37b5c210c8015c500e45325f29/f058b/logged_output-1024x339.png 630w,\n/static/8b594a37b5c210c8015c500e45325f29/40601/logged_output-1024x339.png 945w,\n/static/8b594a37b5c210c8015c500e45325f29/2bef9/logged_output-1024x339.png 1024w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h3>Creating the service connection</h3>\n<p>Here it’s assumed that you already have a key vault an certificate configured.</p>\n<p>First thing you need to do is create an application in your Azure AD.<br>\nAdd a regular text secret to the application as well. You’ll need this for the service connection.</p>\n<p>Now go to your key vault, and add the following access policy. Give Get and List access on certificates, and select your newly created application as the service principal, and save.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/79b81fe38f5ca649d9856b833b697c98/2bef9/access_config-1-1024x485.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 47.46835443037975%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABG0lEQVQoz3WRi27DIAxF8///uG7SJq1NQ0J422DuBE2rpO2QLBvbOlyb4XRecPpdMFqCCoLJFyhfoGMz2fzRlpDxdVlwMYTJZVwdQ/mM2TMGpojCCZAMYUIt/DDJDKDi3Vn1DD2NsFrBrXP30RkM0VkwMyIxLvMKGxkmEExgrIGQi3RArfVhUivO04zrOEIphRgjmAk5ZwwfowMRw6WMn8kgEYGLoEhFlhtgD2ynARNnEBFSShCRh/LhWzOyAMQM68KW3sas74HNZ+bDCu714Z5oY4fgd8VXyD6eV4PgfVfZFJZSOmOQraldjDF9D/9BjvFtjv1uu8J7UwMtywJr7csY7+J9zz4+ALXW8N6/vPoMLCL4VKl/Hp4U/gFV4cM7nLK7XAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"access config 1 1024x485\"\n        title=\"access config 1 1024x485\"\n        src=\"/static/79b81fe38f5ca649d9856b833b697c98/f058b/access_config-1-1024x485.png\"\n        srcset=\"/static/79b81fe38f5ca649d9856b833b697c98/c26ae/access_config-1-1024x485.png 158w,\n/static/79b81fe38f5ca649d9856b833b697c98/6bdcf/access_config-1-1024x485.png 315w,\n/static/79b81fe38f5ca649d9856b833b697c98/f058b/access_config-1-1024x485.png 630w,\n/static/79b81fe38f5ca649d9856b833b697c98/40601/access_config-1-1024x485.png 945w,\n/static/79b81fe38f5ca649d9856b833b697c98/2bef9/access_config-1-1024x485.png 1024w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Before you can set up the service connection you also need to assign the reader role to your application on your subscription. Go to your subscription, and navigate to the role assignment.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4261ea365953164c16f5118033c6fd4a/2bef9/subscription_access-1-1024x450.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 43.67088607594937%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAw0lEQVQoz51RXW/DMAj0//+hfejWJlb8QQFzE3a9ZF37EqQTBsFx4HD5WnC53vB9W0AskGYQteFPIJScwFQhwoAZhtlphDUxEikePJR50uw8wn2NIFYQcU+01ro/ayGuC1gU65YRY0StFaptLH6Y/Bp/VMjMvbiQgHgnUtV97FP5ft//NocGb/Qgp9Q/ZpJt29bVUq0opcAHTxUi0jHi9meDkHPuj9nkSpzQGzye8NwneO0v4fE2TnaEPT/IXvLvMAl/ANabx7kZ+bqlAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"subscription access 1 1024x450\"\n        title=\"subscription access 1 1024x450\"\n        src=\"/static/4261ea365953164c16f5118033c6fd4a/f058b/subscription_access-1-1024x450.png\"\n        srcset=\"/static/4261ea365953164c16f5118033c6fd4a/c26ae/subscription_access-1-1024x450.png 158w,\n/static/4261ea365953164c16f5118033c6fd4a/6bdcf/subscription_access-1-1024x450.png 315w,\n/static/4261ea365953164c16f5118033c6fd4a/f058b/subscription_access-1-1024x450.png 630w,\n/static/4261ea365953164c16f5118033c6fd4a/40601/subscription_access-1-1024x450.png 945w,\n/static/4261ea365953164c16f5118033c6fd4a/2bef9/subscription_access-1-1024x450.png 1024w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Now you can configure your service connection in Azure DevOps with the variables from your subscription and service principal. In Azure DevOps navigate to the new service connection wizard. Select Azure Resource Manager as your connection type, and select the option to authenticate using a manual service principal.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 505px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/bcc6c0a5b82f2ccc6d39d8858ae501b7/c0cb9/service_con-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 182.91139240506325%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAlCAYAAABCr8kFAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAE10lEQVRIx31W53rbOBDUc1zOcokqVWiJvYmkusQiO/3Oce79n2LumyVBS46dH/MBBInF7s7sgq3ddovA9xAGPqIwaObn4JrnOoKg/o4I6zEIfSROjHydoeV7Lr5/+4qnf//Bj+/f8Ov5Jz5/epTnr18+y/zn0xP++/UscB0b45GG6WSMe30qI40axgy2Y6HFU7ebNYo8Exz2O5RFgYfTCdnxgNOplDnfPZxKWeP3WXaE73ti1LZMzGf3cB0HLce2ZGERhYgXURMOn01j3njCDQTXCMs05Hl2rwv4DW2JQYbN0xkyQ+T8y+dP4k2axPKeG9Tmc6iDOLftOmQu0Ct6SBLieCGG1qsldtuNrKnNbxmdnRtkkpdpgs16JaBRhsnEj7ShYDweyRpBo8Z89hsYgWWZlUF6cNjvQQmtlksk8QKLMMAqjbEIfaTJQg6jx9PJpDpkpDWH6tOpGKWdlue5Eh5Z3O+2OB722O/3WO8ybA8FNvsCq81eSGJa9OkEk/HoAvSORPHQlm1ZIlyVv0rcPizbhWHZsBwPhmFKuDSmSHgL69WqYnm1TEV/9FDBmKmkUzJ6k6s/GqSHzCF1SA8Juv7x7haDXheDfg2Z9zAc9H8D1xk29zHH4iFjP5Ul8uwoOSTrSbpEkGwQxGtE6Q6OF/5Ri/ReQmYOZ/WHqiLoMddNwrRgWTYMw5DQ3wpVGV0rUuiRyh3dVsaZvxfo7+buwiBDZu6UsCmhdyviD3jxsM4hvWMXOZUFttuNFP8Fs/Wc629BcqhYJkOUTiXeUEZ6Tl26riPVQ8+jwMdoOEC38xG9LtGRuTYcXLJMY2SZDJdFLnOWobDOnlgWOByOWO9yBPEKXpjCi1J4YYIoirBMYyFyRYNCyjKVsJXAFZRGq7BMYd2ybViWBdt2YNs2HIH1Iht2iIVfdW02BYqURc+RpUa2VaufjDXo03HFul5BvT+TjQE93CAvShTZUSS0TFNxnx5Wrd1GEscSBev+PQnVsjHR0V0Jx3edptGSBBriZo4kikl/r3tfyGa7SnHYbaU7s+1TQswdPyR75168JR31zVlzsOTG4nVAD9gjubHKoY77e12koRqCdobh6+ZAQzQS1Q1UdZ0kiYV9hp4miRzGw/n9zLAwM50aLmZzCvuslg9ZiW9fv8iFz1uvKPLmHi7yXHTIW5DPnx4fcMxLFOUjyodHFKdHIdScz+C5bpVDz/OQpolUhCLivSZw3nQF91XzlVuPlxQ9JBn0iCGTwdc32jkhqrVVo1kL37y8Rk3DEP2pHMlPke9VBJ3Nw8CDNuyj3+2g3+tg0OtIPfPmU3205YhoF1LDrJbj4YDsWNUwaznPM3mXZxm2+wy2G8C0PVj16NQOvIRMHW7WsoEaLMuiIuJUyrr6lWPXsV0fXhAJ/DCG50eiDnYl+WliyLTKDSw3Fjq19xqqXqvanTSYcazfNzk0TUPaz6/nJ8SLsLl7X5cW19Wf2FsH6pNxFTI7S6fbR384wkCb4O7uFrc317i7vWnAZ9V9+r1u1ZEU+Dsy0oQcrrdYOtrUgB3tYIVbDEZTtP/+gOv2VYOrD3/JHxmJGg4HkrcFKypeyG8xo9S0oZRni9rqdDroDzT0+kN0Ol3x6BI3uG630b66qubX7QY31+06ihsY8zn+B81HwfXZdJ6cAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"service con 1\"\n        title=\"service con 1\"\n        src=\"/static/bcc6c0a5b82f2ccc6d39d8858ae501b7/c0cb9/service_con-1.png\"\n        srcset=\"/static/bcc6c0a5b82f2ccc6d39d8858ae501b7/c26ae/service_con-1.png 158w,\n/static/bcc6c0a5b82f2ccc6d39d8858ae501b7/6bdcf/service_con-1.png 315w,\n/static/bcc6c0a5b82f2ccc6d39d8858ae501b7/c0cb9/service_con-1.png 505w\"\n        sizes=\"(max-width: 505px) 100vw, 505px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Now you should be good to throw it into your Azure PowerShell task, and give it a go!</p>\n<h2>Second method: Connect an Azure DevOps library to a key vault</h2>\n<p>This method is way simpler, but will expose your full certificate, including private keys. As above, create a service connection, but add the option to list and get secrets.</p>\n<p>You can now simply create a library in Azure DevOps, and choose the option to link it to your certificates using the service connection. The certificate will be available as a Base64-encoded string under the certificate’s own variable name.</p>\n<p>You can simply use Powershell to read the certificate string and parse it into an X509 certificate, and assign it to a runtime variable using the task.setvariable function mentioned in the first approach.</p>","frontmatter":{"title":"How to fetch a certificate thumbprint from Azure Key Vault in your Azure DevOps pipelines","date":"February 20, 2022","description":null}},"previous":{"fields":{"slug":"/when-you-should-use-decorator-apis-over-class-attributes/"},"frontmatter":{"title":"When you should use decorator APIs over class attributes"}},"next":null},"pageContext":{"id":"46eedf13-191a-5a09-87a2-7f4648f58402","previousPostId":"86222ae0-677d-5de6-9cd9-316018222038","nextPostId":null}},"staticQueryHashes":["2841359383"]}